<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø®ÙŠØ±Ø§ØªÙ†Ø§ | Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #27ae60; --primary-light: #e8f5e9; --accent: #f39c12; 
            --danger: #e74c3c; --bg: #f8fafc; --text: #1e293b;
            --radius: 20px; --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; }
        
        /* ØªØ¨Ø§Ø¹Ø¯ Ø¹Ù„ÙˆÙŠ Ø«Ø§Ø¨Øª Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ØªØ­Øª Ø§Ù„Ù‡ÙŠØ¯Ø± */
        body { background: var(--bg); color: var(--text); padding-top: 100px; min-height: 100vh; }

        /* --- Header (Ø§Ù„Ø±Ø£Ø³ Ø§Ù„Ø«Ø§Ø¨Øª) --- */
        header {
            background: white; height: 80px; position: fixed; top: 0; left: 0; width: 100%; 
            z-index: 9999; display: flex; justify-content: space-between; align-items: center; 
            padding: 0 5%; box-shadow: 0 2px 15px rgba(0,0,0,0.05); border-bottom: 1px solid #eee;
        }
        .logo { font-size: 1.8rem; font-weight: 800; color: var(--primary); cursor: pointer; }
        .nav-controls { display: flex; gap: 10px; align-items: center; }
        .nav-btn { padding: 10px 18px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; transition: 0.3s; display: flex; align-items: center; gap: 5px; }
        .btn-main { background: var(--primary); color: white; }
        .btn-sec { background: var(--primary-light); color: var(--primary); }

        /* --- Products Grid --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; padding: 20px 5%; }
        .card { background: white; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); transition: 0.3s; cursor: pointer; border: 1px solid rgba(0,0,0,0.02); }
        .card:hover { transform: translateY(-8px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        .card-img { width: 100%; height: 200px; object-fit: cover; }
        .card-content { padding: 18px; }

        /* --- Modals (Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©) --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 30px; border-radius: 25px; width: 90%; max-width: 420px; position: relative; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .close { position: absolute; top: 20px; left: 20px; cursor: pointer; font-size: 1.5rem; color: #999; }

        /* --- Auth Tabs --- */
        .auth-tabs { display: flex; gap: 10px; margin-bottom: 25px; background: #f1f5f9; padding: 5px; border-radius: 15px; }
        .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; border-radius: 10px; font-weight: bold; transition: 0.3s; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        input, select, textarea { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #ddd; font-size: 1rem; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .btn-block { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 15px; font-weight: 700; cursor: pointer; font-size: 1.1rem; }
        
        /* Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… Ù„Ù„Ø¨Ø§Ø¦Ø¹ */
        #floatingAddBtn {
            position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; 
            background: var(--accent); color: white; border-radius: 50%; 
            display: none; align-items: center; justify-content: center; font-size: 2rem;
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.4); cursor: pointer; z-index: 9000; transition: 0.3s;
        }
        #floatingAddBtn:hover { transform: scale(1.1) rotate(90deg); }

        /* Ø§Ù„Ø³Ù„Ø© */
        .cart-panel { position: fixed; top: 0; left: -350px; width: 320px; height: 100%; background: white; z-index: 10000; padding: 25px; transition: 0.4s; box-shadow: 10px 0 30px rgba(0,0,0,0.1); }
        .cart-panel.active { left: 0; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.reload()">Ø®ÙŠØ±Ø§ØªÙ†Ø§ ğŸŒ¿</div>
    <div class="nav-controls">
        <button class="nav-btn btn-main" onclick="toggleCart()">ğŸ›’ <span id="cartCount">0</span></button>
        <div id="authArea">
            <button class="nav-btn btn-sec" onclick="openModal('authModal')">Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</button>
        </div>
        <div id="userArea" style="display: none;">
            <button class="nav-btn btn-sec" onclick="openModal('profileModal')">ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ</button>
        </div>
    </div>
</header>

<div id="floatingAddBtn" onclick="openModal('addProdModal')">ï¼‹</div>

<div class="grid" id="productsGrid"></div>

<div id="authModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('authModal')">Ã—</span>
        <div class="auth-tabs">
            <div id="tL" class="tab active" onclick="switchAuth('login')">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</div>
            <div id="tR" class="tab" onclick="switchAuth('reg')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</div>
        </div>
        
        <div id="regFields" style="display: none;">
            <input type="text" id="rName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±">
            <select id="rRole">
                <option value="user">Ø£Ù†Ø§ Ø²Ø¨ÙˆÙ† (Ù…Ø´ØªØ±ÙŠ)</option>
                <option value="seller">Ø£Ù†Ø§ Ø¨Ø§Ø¦Ø¹ (Ø£Ø³Ø±Ø© Ù…Ù†ØªØ¬Ø©)</option>
            </select>
        </div>
        
        <input type="email" id="authEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="password" id="authPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        
        <button class="btn-block" onclick="processAuth()">Ø§Ø³ØªÙ…Ø±Ø§Ø±</button>
    </div>
</div>

<div id="addProdModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('addProdModal')">Ã—</span>
        <h2 style="margin-bottom:20px; text-align:center;">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ ğŸ“¦</h2>
        <input type="text" id="apName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
        <input type="number" id="apPrice" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø±ÙŠØ§Ù„)">
        <input type="text" id="apImg" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ (URL)">
        <button class="btn-block" onclick="saveProduct()">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù†</button>
    </div>
</div>

<div id="profileModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('profileModal')">Ã—</span>
        <div style="text-align:center;">
            <div style="font-size:3.5rem; margin-bottom:10px;">ğŸ‘¤</div>
            <h2 id="profName">...</h2>
            <p id="profRole" style="color:var(--primary); font-weight:bold;"></p>
        </div>
        <hr style="margin:20px 0; opacity:0.1;">
        <button class="btn-block" style="background:var(--danger);" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<script type="module">
    import { createClient } from 'https://jspm.dev/@supabase/supabase-js'
    const supabase = createClient('https://jgmebfsgdwipovwlrqkb.supabase.co', 'sb_publishable_iD-P4dJjZV32-vZldYMZig_VNV2kMHZ');

    let userObj = null, cart = JSON.parse(localStorage.getItem('myCart')) || [];

    window.openModal = id => document.getElementById(id).style.display='flex';
    window.closeModal = id => document.getElementById(id).style.display='none';
    window.toggleCart = () => document.getElementById('cartPanel').classList.toggle('active');

    window.switchAuth = (mode) => {
        const isReg = mode === 'reg';
        document.getElementById('regFields').style.display = isReg ? 'block' : 'none';
        document.getElementById('tL').classList.toggle('active', !isReg);
        document.getElementById('tR').classList.toggle('active', isReg);
    };

    window.processAuth = async () => {
        const email = document.getElementById('authEmail').value;
        const pass = document.getElementById('authPass').value;
        const isReg = document.getElementById('regFields').style.display === 'block';

        if(!email || !pass) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒØ§ÙØ© Ø§Ù„Ø®Ø§Ù†Ø§Øª");

        try {
            if(isReg) {
                const name = document.getElementById('rName').value;
                const role = document.getElementById('rRole').value;
                const { data, error } = await supabase.auth.signUp({ email, password: pass });
                if(error) throw error;
                await supabase.from('profiles').insert([{ id: data.user.id, full_name: name, role: role }]);
                alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨! ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø«Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
            } else {
                const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
                if(error) throw error;
                location.reload();
            }
        } catch(e) { alert("Ø®Ø·Ø£: " + e.message); }
    };

    window.logout = async () => { await supabase.auth.signOut(); location.reload(); };

    async function init() {
        const { data: { user } } = await supabase.auth.getUser();
        if(user) {
            const { data: p } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            if(p) {
                userObj = p;
                document.getElementById('authArea').style.display = 'none';
                document.getElementById('userArea').style.display = 'block';
                document.getElementById('profName').innerText = p.full_name;
                document.getElementById('profRole').innerText = p.role === 'seller' ? 'Ø¨Ø§Ø¦Ø¹ (Ø£Ø³Ø±Ø© Ù…Ù†ØªØ¬Ø©)' : 'Ø²Ø¨ÙˆÙ† Ù…Ù…ÙŠØ²';
                if(p.role === 'seller') document.getElementById('floatingAddBtn').style.display = 'flex';
            }
        }
        loadProducts();
    }

    async function loadProducts() {
        const { data } = await supabase.from('products').select('*').order('created_at', { ascending: false });
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = '';
        data?.forEach(p => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <img src="${p.image_url}" class="card-img" onerror="this.src='https://via.placeholder.com/300x200?text=Image+Not+Found'">
                <div class="card-content">
                    <span style="color:var(--primary); font-size:0.8rem; font-weight:700;">${p.seller_name}</span>
                    <h3 style="margin:5px 0; font-size:1.1rem;">${p.name}</h3>
                    <strong style="color:var(--accent); font-size:1.2rem;">${p.price} Ø±ÙŠØ§Ù„</strong>
                </div>`;
            grid.appendChild(card);
        });
    }

    window.saveProduct = async () => {
        const n = document.getElementById('apName').value, p = document.getElementById('apPrice').value, i = document.getElementById('apImg').value;
        if(!n || !p || !i) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬");
        const { error } = await supabase.from('products').insert([{ name: n, price: p, image_url: i, seller_name: userObj.full_name }]);
        if(error) alert(error.message); else location.reload();
    };

    init();
</script>
</body>
</html>
